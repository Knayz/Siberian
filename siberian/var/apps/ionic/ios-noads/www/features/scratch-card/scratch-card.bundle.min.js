angular.module('starter').controller('ScratchcardViewController',function($rootScope,$scope,$state,$stateParams,$timeout,$translate,Customer,Modal,Dialog,Url,Scratchcard,SB){angular.extend($scope,{value_id:$stateParams.value_id,isLoggedIn:Customer.isLoggedIn(),isLoading:!0,card:{},collection:{},rewards:{},});Scratchcard.value_id=$stateParams.value_id;$scope.pad={password:'',add:function(nbr){if(this.password.length<4){this.password+=nbr;if(this.password.length===4){$scope.validate()}}
return this},remove:function(){this.password=this.password.substr(0,this.password.length-1);return this}};$scope.loadContent=function(){$scope.isLoading=!0;Scratchcard.findAll().success(function(data){$scope.collection=data.collection;$scope.card=data.collection.card;$scope.tc_id=data.tc_id;if($scope.card){$scope.card.is_locked=!1;$scope.card.is_locked_for_attempt=!1;$scope.card.is_locked_for_winner=!1;if(!$scope.card.only_once&&$scope.collection.attempts_for_customer>0){$scope.card.is_locked=!0}
if(($scope.card.only_once&&$scope.card.nb_attempt>0)&&$scope.collection.attempts_for_customer>=$scope.card.nb_attempt){$scope.card.is_locked=!0;$scope.card.is_locked_for_attempt=!0}
if($scope.card.winner_max<=$scope.collection.nb_winners){$scope.card.is_locked=!0;$scope.card.is_locked_for_winner=!0}}
$scope.page_title=data.page_title}).finally(function(){$scope.isLoading=!1})};$scope.openPad=function(reward){if(!Customer.isLoggedIn()){$scope.login();return}
$scope.pad.modal={};$scope.pad.password="";$scope.pad.buttons=[];for(var i=0;i<10;i++){$scope.pad.buttons.push(i)}
$scope.pad.reward=reward;Modal.fromTemplateUrl('templates/loyalty-card/l1/pad.html',{scope:$scope,animation:'slide-in-up'}).then(function(modal){$scope.pad.modal=modal;$scope.pad.modal.show()})};$scope.imageSrc=function(path){if(path.indexOf('/')===0){return IMAGE_URL+'images/application'+path}
return path};$scope.closePad=function(){$scope.pad.modal.hide()};$scope.validate=function(){Scratchcard.validate($scope.pad).success(function(data){if(data){if(data.message){Dialog.alert('',data.message,'OK').then(function(){if(data.close_pad){$scope.closePad()}else{$scope.pad.password=''}})}
$timeout(function(){$scope.loadContent()})}}).error(function(data){if(data&&data.message){Dialog.alert('Error',data.message,'OK').then(function(){if(data.close_pad){$scope.closePad()}else{$scope.pad.password=""}})}})};$scope.login=function(){Customer.loginModal($scope)};$scope.alertLogin=function(){var message='';if($scope.card.is_locked_for_attempt){message=$translate.instant('You have already used your daily limit for this card. Come back tomorrow!','scratchcard')}else if($scope.card.is_locked_for_winner){message=$translate.instant('Sorry, but the maximum number of winners for this card has been reached. Come back for the next game!','scratchcard')}else{message=$translate.instant('Log in to scratch your card!','scratchcard')}
Dialog.alert('Sorry!',message,'OK',-1,'scratchcard')};$scope.log=function(is_win,points_earned){if(Customer.id){is_win=is_win?"1":"0";Scratchcard.logAttempt($scope.card.card_id,Customer.id,$scope.card.reward.reward_id,is_win,points_earned).success(function(data){if(data.success){}else{if(is_win){Dialog.alert('Error','Error while creating your reward. Sorry for the inconvenience.','OK')}}}).error(function(data){if(data&&data.message){Dialog.alert('Error',data.message,'OK')}})}};$scope.endScratch=function(){$timeout(function(){$scope.card={};$scope.loadContent()},1)};$scope.showTc=function(){$state.go('tc-view',{tc_id:$scope.tc_id})};$scope.$on('$destroy',function(){if($scope.pad.modal){$scope.pad.modal.remove()}});$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.isLoggedIn=!0;$scope.loadContent()});$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.isLoggedIn=!1;$scope.loadContent()});$scope.loadContent()});angular.module('starter').directive('sbScratch',function(){return{restrict:'A',scope:{card:"=",valueId:"=",customerId:"=",endScratch:"&",log:"&"},template:'<div class="container item item-image" '+'     id="scratch-container" '+'     ng-show="image_is_loaded">'+'   <canvas class="canvas" '+'           id="scratch-canvas" '+'           width="{{ card_width }}px" '+'           height="{{ card_height }}px"></canvas>'+'   <img ng-src="{{ imageSrc(background_image) }}" />'+'</div>',controller:function($document,Dialog,$rootScope,$scope,$timeout,$translate){$scope.imageSrc=function(path){if(path.indexOf('/')===0){return IMAGE_URL+'images/application'+path}
return path};$scope.distanceBetween=function(point1,point2){return Math.sqrt(Math.pow(point2.x-point1.x,2)+Math.pow(point2.y-point1.y,2))};$scope.angleBetween=function(point1,point2){return Math.atan2(point2.x-point1.x,point2.y-point1.y)};$scope.getFilledInPixels=function(stride){if(!stride||stride<1){stride=1}
var pixels=$scope.ctx.getImageData(0,0,$scope.canvasWidth,$scope.canvasHeight),pdata=pixels.data,l=pdata.length,total=(l/stride),count=0;for(var i=count=0;i<l;i+=stride){if(parseInt(pdata[i])===0){count++}}
return Math.round((count/total)*100)};$scope.getMouse=function(e,canvas){var offsetX=0,offsetY=0,mx,my;if(canvas.offsetParent!==undefined){do{offsetX+=canvas.offsetLeft;offsetY+=canvas.offsetTop}while((canvas=canvas.offsetParent));}
$scope.ratioW=$scope.container.clientWidth/$scope.canvas.width;$scope.ratioH=$scope.container.clientHeight/$scope.canvas.height;mx=(e.pageX||e.touches[0].clientX)-offsetX;my=(e.pageY||e.touches[0].clientY)-offsetY;return{x:mx/$scope.ratioW,y:my/$scope.ratioH}};$scope.handlePercentage=function(filledInPixels){filledInPixels=filledInPixels||0;if(!$scope.attempt_is_logged){$scope.log({is_win:$scope.is_win,points_earned:$scope.points_earned});$scope.attempt_is_logged=!0}
if(filledInPixels>75){$scope.handleScratchEnd()}};$scope.handleMouseDown=function(e){e.stopPropagation();$scope.isDrawing=!0;$scope.lastPoint=$scope.getMouse(e,$scope.canvas)};$scope.handleMouseMove=function(e){if(!$scope.isDrawing){return}
e.preventDefault();var currentPoint=$scope.getMouse(e,$scope.canvas),dist=$scope.distanceBetween($scope.lastPoint,currentPoint),angle=$scope.angleBetween($scope.lastPoint,currentPoint),x,y;for(var i=0;i<dist;i++){x=$scope.lastPoint.x+(Math.sin(angle)*i)-25;y=$scope.lastPoint.y+(Math.cos(angle)*i)-25;$scope.ctx.globalCompositeOperation='destination-out';var reg=/^translate3d\(-?\d+px, (-?\d+)px, -?\d+px\)/;var txt=document.getElementsByClassName("scroll")[0].style.transform;var resultat=txt.match(reg);var offset=0;if(resultat&&resultat[1]){offset=parseInt(resultat[1])+25}
y-=offset;$scope.ctx.drawImage($scope.brush,x,y)}
$scope.lastPoint=currentPoint;$scope.handlePercentage($scope.getFilledInPixels(32))};$scope.handleMouseUp=function(e){$scope.isDrawing=!1};$scope.imageSrcWin=function(path){if(path.indexOf('/')===0){return IMAGE_URL+'images/application'+path}
return IMAGE_URL+'app/local/modules/ScratchCard/resources/media/images/image_popup_win.jpg'};$scope.imageSrcLose=function(path){if(path.indexOf('/')===0){return IMAGE_URL+'images/application'+path}
return IMAGE_URL+'app/local/modules/ScratchCard/resources/media/images/image_popup_lose.jpg'};$scope.handleScratchEnd=function(){$scope.canvas.parentNode.removeChild($scope.canvas);$scope.mypopup=$scope.is_win?$scope.card.popups.win:$scope.card.popups.lose;$scope.show_desc=!!$scope.mypopup.description;var popupImage=$scope.mypopup.image;if($scope.is_win){$scope.popup_image_url=$scope.imageSrcWin(popupImage)}else{$scope.popup_image_url=$scope.imageSrcLose(popupImage)}
var template='<img class="'+($scope.popup_image_url?'':' ng-hide')+'" '+'     src="'+($scope.popup_image_url)+'" />';if($scope.show_desc){template+='<p class="item-text-wrap">'+'   '+$scope.mypopup.description+'</p>'}
if($scope.points_earned){template+='<p class="congratz">'+'   <span>'+'       <i class="ion-ios-star"></i> '+$scope.points_earned+''+'   </span> '+$translate.instant('points','scratchcard')+''+'</p>'}
Dialog.alert($scope.mypopup.title,template,'OK',-1).then(function(){$scope.endScratch()})};$scope.getRandomPoints=function(min,max){min=Math.ceil(min);max=Math.floor(max);return Math.floor(Math.random()*(max-min+1))+min};$scope.isDrawing=!1;$scope.lastPoint=null;$scope.attempt_is_logged=!1;$scope.card_width=300;$scope.card_height=400;$scope.container=$document[0].getElementById('scratch-container');$scope.canvas=$document[0].getElementById('scratch-canvas');$scope.image_is_loaded=!1;$scope.canvasWidth=$scope.canvas.width;$scope.canvasHeight=$scope.canvas.height;$scope.ctx=$scope.canvas.getContext('2d');$scope.image=new Image();$scope.brush=new Image();$scope.image.crossOrigin='';$scope.image.src=$scope.imageSrc($scope.card.image_foreground);$scope.getLucky=function(winPercentage){var random=_.random(0,100000000);return(random<=winPercentage)};$scope.is_win=$scope.getLucky($scope.card.win_percentage_new);if(($scope.card.is_point>0)&&$scope.is_win){$scope.points_earned=$scope.getRandomPoints($scope.card.min_points,$scope.card.max_points)}else{$scope.points_earned=null}
$scope.background_image=$scope.is_win?$scope.imageSrc($scope.card.image_win):$scope.imageSrc($scope.card.image_lose);$scope.image.onload=function(){$scope.ctx.drawImage($scope.image,0,0);$timeout(function(){$scope.image_is_loaded=!0})};$scope.brush.src='data:image/png;base64,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';$scope.canvas.addEventListener('mousedown',$scope.handleMouseDown,!1);$scope.canvas.addEventListener('touchstart',$scope.handleMouseDown,!1);$scope.canvas.addEventListener('mousemove',$scope.handleMouseMove,!1);$scope.canvas.addEventListener('touchmove',$scope.handleMouseMove,!1);$scope.canvas.addEventListener('mouseup',$scope.handleMouseUp,!1);$scope.canvas.addEventListener('touchend',$scope.handleMouseUp,!1)}}});angular.module('starter').factory('Scratchcard',function($pwaRequest){var factory={value_id:null};factory.findAll=function(){if(!this.value_id){return $pwaRequest.reject('[Scratchcard::findAll] missing value_id')}
return $pwaRequest.get('/scratchcard/mobile_view/findall',{urlParams:{value_id:this.value_id,},cache:!1})};factory.logAttempt=function(cardId,rewardId,isWin,points){if(!this.value_id){return $pwaRequest.reject('[Scratchcard::logAttempt] missing value_id')}
return $pwaRequest.post('/scratchcard/mobile_view/logattempt',{urlParams:{value_id:this.value_id,},data:{card_id:cardId,reward_id:rewardId,win:isWin,points:points}})};factory.validate=function(pad){if(!this.value_id){return $pwaRequest.reject('[Scratchcard::validate] missing value_id')}
return $pwaRequest.post('/scratchcard/mobile_view/validate',{urlParams:{value_id:this.value_id,},data:{value_id:this.value_id,reward_id:pad.reward.attempt_id,password:pad.password}})};return factory});Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.module-scratchcard.scratch-card-view .container{border:3px solid red;position:relative;margin:0 auto;user-select:none}.module-scratchcard.scratch-card-view .container img{width:100%}.module-scratchcard.scratch-card-view .canvas{width:100%;position:absolute;top:0;left:0}.module-scratchcard.scratch-card-view .congratz{text-align:center}.module-scratchcard.scratch-card-view .congratz span{font-weight:700;font-size:20px}","scratch-card")